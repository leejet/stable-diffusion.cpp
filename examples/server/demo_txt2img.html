<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stable Diffusion Chat</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            box-sizing: border-box;
            overflow: hidden;
            background: transparent;
            border-radius: 0;
            box-shadow: none;
        }
        /* Layout */
        body, html {height: 100%;}
        .sidebar {
            width: 260px;
            background: #fff;
            border-right: 1px solid #eee;
            padding: 20px;
            box-sizing: border-box;
        }
        .sidebar h2 {margin-top:0}
        .sidebar label {display:block;margin-top:12px;font-size:13px;color:#555}
        .sidebar select, .sidebar input {width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:4px}

        .main {flex:1;display:flex;flex-direction:column;}
        .sidebar .title {
            background: #007acc;
            color: white;
            padding: 10px 12px;
            font-size: 16px;
            margin: -20px -20px 12px -20px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }
        .chat {
            flex:1;
            overflow-y: auto;
            padding: 20px;
            background: white;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            max-width: 70%;
        }
        .message.user {
            background: #007acc;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .message.bot {
            background: #f0f0f0;
            margin-right: auto;
        }
        .message img {
            max-width: 100%;
            border-radius: 5px;
        }

        /* color scheme: white / gray / black */
        body { background: #f3f3f3; color: #111; }
        .sidebar { background: #ffffff; color: #111; }
        .sidebar label { color: #111; }
        .sidebar input { background: #fff; color: #111; border: 1px solid #ddd; }
        .sidebar .title { background: #111; color: #fff; }

        .message.user { background: #111; color: #fff; }
        .message.bot { background: #fff; color: #111; border: 1px solid #e6e6e6; }

        .image-wrapper { display:flex; align-items:center; gap:8px; background:#fff; padding:8px; border-radius:6px; }
        .chat-image { max-width:220px; cursor: zoom-in; border-radius:4px; display:block; }
        .download-btn { padding:6px 8px; background:#111; color:#fff; text-decoration:none; border-radius:4px; font-size:12px; }

        /* lightbox */
        #lightbox { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.75); z-index:9999; }
        #lightbox .content { position:relative; max-width:90%; max-height:90%; }
        #lightbox img { max-width:100%; max-height:100%; display:block; border-radius:6px; }
        #lightbox .download-btn { position:absolute; top:8px; right:8px; z-index:2; }
        #lightbox .close-btn { position:absolute; top:8px; left:8px; z-index:2; background:#fff; border:none; padding:6px 8px; cursor:pointer; border-radius:4px; }
        .input-area {
            padding: 14px 20px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #eee;
        }
        .input-area input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        .input-area button {
            padding: 10px 20px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .input-area button:hover {
            background: #005aa3;
        }
        .input-area button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2 class="title">Stable Diffusion Cpp Chat</h2>
            <label>Width</label>
            <input id="width" type="number" min="64" max="2048" value="512" />
            <label>Height</label>
            <input id="height" type="number" min="64" max="2048" value="512" />
            <label>Steps</label>
            <input id="steps" type="number" min="1" max="1000" value="20" />
            <label>Batch</label>
            <input id="batch" type="number" min="1" max="8" value="1" />
        </aside>
        <main class="main">
            <div class="chat" id="chat"></div>
            <div class="input-area">
                <input id="prompt" type="text" placeholder="Enter your prompt..." />
                <button id="inlineGenerateBtn" onclick="generate()">Generate</button>
            </div>
        </main>
    </div>
    <script>
        const chat = document.getElementById('chat');
        const promptInput = document.getElementById('prompt');
        const generateBtns = document.querySelectorAll('#generateBtn, #inlineGenerateBtn');

        function addMessage(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + type;
            if (typeof content === 'string') {
                messageDiv.innerHTML = content;
            } else if (content instanceof Node) {
                messageDiv.appendChild(content);
            }
            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
        }

        function setGenerating(on) {
            generateBtns.forEach(b => { b.disabled = on; b.textContent = on ? 'Generating...' : 'Generate'; });
        }

        function generate() {
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            const width = parseInt(document.getElementById('width').value, 10);
            const height = parseInt(document.getElementById('height').value, 10);
            const steps = parseInt(document.getElementById('steps').value, 10);
            const batch = parseInt(document.getElementById('batch').value, 10);

            addMessage('user', prompt + `<div style="font-size:12px;color:#666;margin-top:6px">${width}x${height} • ${steps} steps • ${batch} images</div>`);
            promptInput.value = '';
            setGenerating(true);

            fetch('/v1/images/generations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: prompt,
                    response_format: 'b64_json',
                    width: width,
                    height: height,
                    steps: steps,
                    n: batch
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.data && data.data.length) {
                    const fmt = (data.output_format || 'png');
                    data.data.forEach((d, idx) => {
                        if (d.b64_json) {
                            const dataUri = 'data:image/' + fmt + ';base64,' + d.b64_json;
                            const wrapper = document.createElement('div');
                            wrapper.className = 'image-wrapper';

                            const img = document.createElement('img');
                            img.className = 'chat-image';
                            img.src = dataUri;
                            img.alt = 'Generated image ' + (idx+1);
                            img.addEventListener('click', () => {
                                openLightbox(dataUri, fmt);
                            });

                            const a = document.createElement('a');
                            a.className = 'download-btn';
                            a.href = dataUri;
                            a.download = 'image.' + fmt;
                            a.textContent = 'Download';

                            wrapper.appendChild(img);
                            wrapper.appendChild(a);

                            addMessage('bot', wrapper);
                        }
                    });
                } else {
                    addMessage('bot', 'Error: No image generated');
                }
            })
            .catch(error => {
                addMessage('bot', 'Error: ' + error.message);
            })
            .finally(() => {
                setGenerating(false);
            });
        }

        promptInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                generate();
            }
        });
        // lightbox handlers
        function openLightbox(dataUri, fmt) {
            const lb = document.getElementById('lightbox');
            const lbImg = document.getElementById('lightbox-img');
            const lbDl = document.getElementById('lightbox-download');
            lbImg.src = dataUri;
            lbDl.href = dataUri;
            lbDl.download = 'image.' + fmt;
            lb.style.display = 'flex';
        }
        function closeLightbox() {
            const lb = document.getElementById('lightbox');
            const lbImg = document.getElementById('lightbox-img');
            lbImg.src = '';
            lb.style.display = 'none';
        }
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeLightbox(); });
        
    </script>

    <div id="lightbox" onclick="closeLightbox()">
        <div class="content" onclick="event.stopPropagation()">
            <button class="close-btn" onclick="closeLightbox()">Close</button>
            <img id="lightbox-img" src="" alt="" />
            <a id="lightbox-download" class="download-btn" href="#">Download</a>
        </div>
    </div>
</body>
</html>